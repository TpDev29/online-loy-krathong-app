<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏•‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå | Krathong Online</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for Inter font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'water-dark': '#0f172a', // Dark Blue for night water
                        'water-light': '#1e293b',
                        'moon-gold': '#facc15', // Gold accent
                        'lotus-pink': '#ec4899', // Pink for lotus
                    }
                }
            }
        }
    </script>
    <style>
        /* SCENE: The main visual container for the water and krathongs */
        .krathong-scene {
            position: relative;
            overflow: hidden; 
            min-height: 40rem; 
            
            /* --- Deep Night Sky Gradient & Water (Using Lighter Blue Water #1e3a5f) --- */
            background: linear-gradient(
                to bottom, 
                #030712 0%,   /* Very Dark Blue/Grey Sky (Top) */
                #0d172e 40%,  /* Deep Navy Horizon */
                #1e3a5f 75%   /* Medium Dark Blue Water */
            ); 
            
            border-radius: 0 0 1rem 1rem;
            z-index: 1; /* Ensure krathongs are above waves */
        }
        
        /* Moon Styling */
        .moon {
            position: absolute;
            top: 5%;
            right: 15%;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #facc15; /* moon-gold */
            box-shadow: 
                0 0 15px 5px rgba(250, 202, 21, 0.6), /* Inner glow */
                0 0 30px 10px rgba(250, 202, 21, 0.4); /* Outer glow */
            z-index: 15; 
        }

        /* --- Star Styling for the Sky --- */
        .star-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 40%; 
            overflow: hidden;
            pointer-events: none; 
        }
        
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0; 
            box-shadow: 0 0 1px 0.5px rgba(255, 255, 255, 0.7);
            animation: twinkle linear infinite; 
            z-index: 10; 
        }

        /* Animation for stars */
        @keyframes twinkle {
            0%, 100% {
                opacity: 0.8;
                transform: scale(1);
            }
            50% {
                opacity: 0.2;
                transform: scale(0.5); 
            }
        }
        /* ------------------------------------ */
        
        /* --- UPDATED: Slow, Curved, Upward Wave Effect on the Water --- */
        .krathong-scene::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70%; 
            
            /* Vertical gradient with soft bands to create a curved look */
            background: linear-gradient(
                180deg, /* Straight vertical gradient */
                rgba(30, 58, 95, 0.0) 0%,   /* Start with low opacity */
                rgba(0, 0, 0, 0.4) 15%,     /* Darker band (wave trough) */
                rgba(30, 58, 95, 0.2) 35%,  /* Lighter band (wave crest) */
                rgba(0, 0, 0, 0.4) 55%,
                rgba(30, 58, 95, 0.2) 75%,
                rgba(0, 0, 0, 0.4) 95%
            );
            /* Tall background size makes the bands look curved and wide */
            background-size: 100% 600px; 
            animation: waveFlow 40s linear infinite; /* Very slow flow (40 seconds) */
            opacity: 0.7; 
            z-index: 0; 
        }

        @keyframes waveFlow {
            from {
                /* Start at the bottom of the pattern */
                background-position: 0% 100%; 
            }
            to {
                /* End at the top of the pattern (moves upward only) */
                background-position: 0% 0%; 
            }
        }
        /* End of Wave CSS */

        /* Krathong styling for the visual scene */
        .floating-krathong-item {
            position: absolute;
            cursor: pointer;
            transition: all 0.5s ease-out;
            z-index: 20;
            /* Ensure krathong icon is large */
            font-size: 3rem; 
            line-height: 1;
        }

        /* Animation for floating krathongs (keep this) */
        @keyframes floatEffect {
            0% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-5px) rotate(1deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }

        .krathong-float {
            animation: floatEffect 4s ease-in-out infinite;
        }

        /* Speech bubble styling for name and wish: NOW ALWAYS VISIBLE */
        .speech-bubble {
            position: absolute;
            /* Position slightly above and to the right of the krathong icon */
            top: -5px; 
            left: 100%; 
            transform: none; 
            opacity: 1; /* ALWAYS VISIBLE */
            visibility: visible; /* ALWAYS VISIBLE */
            transition: opacity 0.3s ease; 
            min-width: 120px; 
            max-width: 180px;
            background-color: rgba(255, 255, 255, 0.95); 
            color: #1e293b;
            padding: 6px 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.4);
            font-weight: 500;
            z-index: 50; 
        }

        /* Adjust the pointer of the bubble */
        .speech-bubble::after {
            content: '';
            position: absolute;
            top: 15px; 
            left: -8px; 
            margin-left: 0;
            border-width: 8px;
            border-style: solid;
            border-color: transparent rgba(255, 255, 255, 0.95) transparent transparent; 
        }
        
        /* Custom style for the Krathong selection buttons */
        .krathong-select-button:checked + label {
            border-color: #facc15;
            background-color: #4c515a33;
            box-shadow: 0 0 10px rgba(250, 202, 21, 0.5);
        }
    </style>
</head>
<body class="bg-water-dark min-h-screen font-sans text-white antialiased p-4">

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let userId = null;
        const KRATHONG_COLLECTION = 'krathongs';

        // --- CONFIGURATION FOR VERCEL DEPLOYMENT ---
        // **** ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ****

        // 1. PROJECT ID: ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á Collection Path ‡πÉ‡∏ô Firestore (‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö __app_id)
        // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏õ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const PROJECT_APP_ID = 'loy-krathong-vercel-2025'; 

        // 2. FIREBASE CONFIG: ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON Configuration Object ‡∏à‡∏≤‡∏Å Firebase Console ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        // (Settings > Project settings > General > Your apps > Firebase SDK snippet > Config)
        const firebaseConfig = {
          apiKey: "AIzaSyC9GFLbMJhYNeRNwod_XPK3ngQh7b4rsAE",
          authDomain: "loy-krathong-vercel-2025.firebaseapp.com",
          projectId: "loy-krathong-vercel-2025",
          storageBucket: "loy-krathong-vercel-2025.firebasestorage.app",
          messagingSenderId: "1015035525573",
          appId: "1:1015035525573:web:8f6dd97206e1004f5533ac"
        };

        // --------------------------------------------

        const KRATHONG_PATH = (appId) => `/artifacts/${appId}/public/data/${KRATHONG_COLLECTION}`;

        // --- UI Utility Functions ---
        // UPDATED KRATHONG ICONS AND TYPES (Using SVG for a more realistic look)
        window.KRATHONG_ICONS = {
            'BananaLeaf': `<svg viewBox="0 0 48 48" class="w-12 h-12 mx-auto" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M40 24C40 33.9411 31.9411 42 22 42C12.0589 42 4 33.9411 4 24C4 14.0589 12.0589 6 22 6C31.9411 6 40 14.0589 40 24Z" fill="#38A169" opacity="0.8"/><path d="M40 24C40 30 35 34 24 34H20C9 34 4 30 4 24" fill="#68D391" opacity="0.6"/><rect x="22" y="16" width="4" height="12" rx="2" fill="#9F7A3E"/><path d="M24 10C24 8 26 8 26 10C26 12 24 14 24 14C24 14 22 12 22 10C22 8 24 8 24 10Z" fill="#FDE68A"/><path d="M24 10C24 9 25 9 25 10C25 11 24 12 24 12C24 12 23 11 23 10C23 9 24 9 24 10Z" fill="#F6AD55"/><rect x="27" y="24" width="2" height="6" rx="1" fill="#4A5568"/><rect x="19" y="24" width="2" height="6" rx="1" fill="#4A5568"/></svg>`, // ‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡πÉ‡∏ö‡∏ï‡∏≠‡∏á (Banana Leaf)
            'Lotus': `<svg viewBox="0 0 48 48" class="w-12 h-12 mx-auto" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M24 42C30 42 38 38 42 32C46 26 44 18 36 18C36 18 30 14 24 14C18 14 12 18 12 18C4 18 2 26 6 32C10 38 18 42 24 42Z" fill="#EC4899" opacity="0.7"/><path d="M24 14L28 26H20L24 14Z" fill="#F9A8D4"/><path d="M12 18L18 30L6 32L12 18Z" fill="#F9A8D4"/><path d="M36 18L30 30L42 32L36 18Z" fill="#F9A8D4"/><rect x="22" y="18" width="4" height="10" rx="2" fill="#FBBF24"/><path d="M24 12C24 10 26 10 26 12C26 14 24 16 24 16C24 16 22 14 22 12C22 10 24 10 24 12Z" fill="#FDE68A"/><rect x="27" y="26" width="2" height="4" rx="1" fill="#4A5568"/><rect x="19" y="26" width="2" height="4" rx="1" fill="#4A5568"/></svg>`,     // ‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡∏î‡∏≠‡∏Å‡∏ö‡∏±‡∏ß (Lotus)
            'Classic': `<svg viewBox="0 0 48 48" class="w-12 h-12 mx-auto" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="24" cy="40" r="10" fill="#9F7A3E"/><path d="M34 35C34 37 32 37 24 37C16 37 14 37 14 35C14 33 24 25 24 25C24 25 34 33 34 35Z" fill="#A0AEC0"/><path d="M24 20C28 20 30 24 30 26C30 28 24 30 24 30C24 30 18 28 18 26C18 24 20 20 24 20Z" fill="#38A169"/><rect x="22" y="12" width="4" height="10" rx="2" fill="#FFFFFF"/><path d="M24 8C24 6 26 6 26 8C26 10 24 12 24 12C24 12 22 10 22 8C22 6 24 6 24 8Z" fill="#FDE68A"/><rect x="27" y="18" width="2" height="4" rx="1" fill="#4A5568"/><rect x="19" y="18" width="2" height="4" rx="1" fill="#4A5568"/></svg>`,   // ‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏° (Classic)
            'Coconut': `<svg viewBox="0 0 48 48" class="w-12 h-12 mx-auto" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M40 28C40 35.732 32.8366 42 24 42C15.1634 42 8 35.732 8 28H40Z" fill="#78350F"/><path d="M24 26C27.3137 26 30 23.3137 30 20C30 16.6863 27.3137 14 24 14C20.6863 14 18 16.6863 18 20C18 23.3137 20.6863 26 24 26Z" fill="#FBBF24"/><rect x="22" y="10" width="4" height="10" rx="2" fill="#FFFFFF"/><path d="M24 6C24 4 26 4 26 6C26 8 24 10 24 10C24 10 22 8 22 6C22 4 24 4 24 6Z" fill="#FDE68A"/><rect x="27" y="18" width="2" height="4" rx="1" fill="#4A5568"/><rect x="19" y="18" width="2" height="4" rx="1" fill="#4A5568"/></svg>`,    // ‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡∏Å‡∏∞‡∏•‡∏≤‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß (Coconut)
        };
        
        // Initialize Firebase and Authentication
        const initFirebase = async () => {
            try {
                // Set Firestore logging to Debug for visibility
                setLogLevel('Debug');

                // *** LOGIC FOR FIREBASE CONFIGURATION ***
                let appId;
                let firebaseConfig;
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                // 1. Check for Canvas Global Variables
                if (typeof __app_id !== 'undefined' && typeof __firebase_config !== 'undefined') {
                    appId = __app_id;
                    firebaseConfig = JSON.parse(__firebase_config);
                    console.log("Using Canvas Global Config.");
                } else {
                    // 2. Fallback for Vercel/Production Environment (Uses hardcoded values)
                    appId = PROJECT_APP_ID;
                    firebaseConfig = FIREBASE_CONFIG_JSON;
                    
                    // Sanity check for Vercel/Production environment
                    if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                        throw new Error("Firebase configuration is missing or still using placeholder values (YOUR_API_KEY). Please update FIREBASE_CONFIG_JSON in the script.");
                    }
                    console.log("Using Hardcoded Production Config.");
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate user
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User signed in. UID:", userId);
                        document.getElementById('user-id-display').textContent = userId;
                        setupRealtimeListener(appId);
                        document.getElementById('loading-status').textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!';
                    } else {
                        // Sign in using custom token (Canvas) or anonymously (Vercel)
                        try {
                            if (initialAuthToken) {
                                // Canvas-specific token authentication
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                // Standard anonymous sign-in for Vercel deployment
                                await signInAnonymously(auth);
                            }
                        } catch (e) {
                            console.error("Authentication failed:", e);
                            showFeedback('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ: ' + e.message, 'error');
                        }
                    }
                });

            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                document.getElementById('loading-status').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                showFeedback('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message, 'error');
            }
        };

        // --- Realtime Data Listener (Latest 100 Krathongs) ---
        const setupRealtimeListener = (appId) => {
            const krathongsRef = collection(db, KRATHONG_PATH(appId));
            const q = query(krathongsRef, orderBy('timestamp', 'desc'), limit(100));
            
            const krathongListElement = document.getElementById('krathong-list');

            onSnapshot(q, (snapshot) => {
                let krathongsHtml = '';
                
                // Keep the moon and star container elements if they exist before clearing.
                const moonElement = document.querySelector('.moon');
                const starContainerElement = document.getElementById('star-container');

                krathongListElement.innerHTML = '';
                if (starContainerElement) {
                     krathongListElement.appendChild(starContainerElement);
                }
                if (moonElement) {
                     krathongListElement.appendChild(moonElement);
                }
                
                if (snapshot.empty) {
                     krathongsHtml = '<div class="text-center p-8 text-gray-400 absolute inset-0 flex items-center justify-center z-30">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡∏•‡∏≠‡∏¢‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏•‡∏≥‡∏ô‡πâ‡∏≥‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢! ‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏•‡∏≠‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞.</div>';
                     krathongListElement.innerHTML += krathongsHtml;
                     return;
                }
                
                // Helper to generate a stable pseudo-random number based on the document ID
                const hashString = (s) => {
                    let hash = 0;
                    for (let i = 0; i < s.length; i++) {
                        hash = ((hash << 5) - hash) + s.charCodeAt(i);
                        hash |= 0; // Convert to 32bit integer
                    }
                    return Math.abs(hash);
                };

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // krathongIcon now holds the SVG string
                    const krathongIcon = window.KRATHONG_ICONS[data.krathongType] || window.KRATHONG_ICONS['Classic'];
                    const docHash = hashString(doc.id) % 10000;
                    
                    // Generate pseudo-random coordinates based on the document hash
                    // X position: 10% to 90%
                    const x = (docHash % 80) + 10;
                    // Y position: 40% to 90% (lower half of the scene for water)
                    const y = (Math.floor(docHash / 100) % 50) + 40;

                    // Vary animation duration slightly
                    const floatDuration = 4 + (docHash % 3); 

                    krathongsHtml += `
                        <div class="floating-krathong-item krathong-float" 
                             style="left: ${x}%; top: ${y}%; animation-duration: ${floatDuration}s; transform: scale(1);">
                            
                            <!-- Krathong Icon (Now SVG) -->
                            <div class="leading-none flex-shrink-0">${krathongIcon}</div>
                            
                            <!-- Speech Bubble: Now always visible -->
                            <div class="speech-bubble">
                                <p class="text-xs font-bold truncate">${data.name || '‡∏ú‡∏π‡πâ‡∏•‡∏≠‡∏¢‡∏ô‡∏¥‡∏£‡∏ô‡∏≤‡∏°'}</p>
                                <p class="text-[0.65rem] italic text-gray-700 leading-tight mt-0.5 max-h-8 overflow-hidden">"${data.wish || '‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç'}"</p>
                            </div>
                        </div>
                    `;
                });

                // Insert krathongs after moon and star container
                krathongListElement.insertAdjacentHTML('beforeend', krathongsHtml);

            }, (error) => {
                console.error("Error fetching krathongs: ", error);
                krathongListElement.innerHTML = '<div class="text-center p-8 text-red-400 absolute inset-0 flex items-center justify-center z-30">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</div>';
                showFeedback('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå', 'error');
            });
        };

        // --- Star Generation Logic ---
        const createStars = () => {
            const starContainer = document.getElementById('star-container');
            if (!starContainer) return;
            
            const numberOfStars = 150; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏î‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£

            for (let i = 0; i < numberOfStars; i++) {
                const star = document.createElement('div');
                star.className = 'star';

                // ‡∏™‡∏∏‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏î‡∏≤‡∏ß 1px ‡∏ñ‡∏∂‡∏á 2px
                const size = Math.random() * 1 + 1; 
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;

                // ‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Star Container (‡∏ã‡∏∂‡πà‡∏á‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ü‡πâ‡∏≤)
                star.style.top = `${Math.random() * 100}%`; 
                star.style.left = `${Math.random() * 100}%`; 

                // ‡∏™‡∏∏‡πà‡∏° Animation Delay ‡πÅ‡∏•‡∏∞ Duration
                star.style.animationDelay = `${Math.random() * 5}s`;
                star.style.animationDuration = `${Math.random() * 3 + 1.5}s`;

                starContainer.appendChild(star);
            }
            console.log(`Created ${numberOfStars} stars.`);
        };


        // --- Floating Krathong Logic (Unchanged) ---
        window.floatKrathong = async () => {
            if (!userId) {
                showFeedback('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
                return;
            }

            const name = document.getElementById('full-name').value.trim();
            const wish = document.getElementById('wish').value.trim();
            const krathongType = document.querySelector('input[name="krathongType"]:checked')?.value;

            if (!name || !wish || !krathongType) {
                showFeedback('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏≠‡∏¢', 'warning');
                return;
            }

            const floatButton = document.getElementById('float-button');
            floatButton.disabled = true;
            floatButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ó‡∏á...';
            
            try {
                // Determine the correct appId source
                const currentAppId = typeof __app_id !== 'undefined' ? __app_id : PROJECT_APP_ID;
                const krathongsRef = collection(db, KRATHONG_PATH(currentAppId));
                
                await addDoc(krathongsRef, {
                    name: name,
                    wish: wish,
                    krathongType: krathongType,
                    userId: userId,
                    timestamp: serverTimestamp()
                });

                // Success
                document.getElementById('krathong-form').reset();
                toggleFloatModal(false);
                // The icon is now SVG, so we display a generic success message
                showFeedback(`‡∏•‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏©‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ`, 'success');

            } catch (e) {
                console.error("Error adding document: ", e);
                showFeedback('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ó‡∏á: ' + e.message, 'error');
            } finally {
                floatButton.disabled = false;
                floatButton.textContent = '‡∏•‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ó‡∏á';
            }
        };

        
        // Show/Hide Modal for Floating Krathong
        window.toggleFloatModal = (show) => {
            const modal = document.getElementById('float-modal');
            if (show) {
                modal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            } else {
                modal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }
        };

        // Custom Feedback/Alert Box (Replaces alert())
        const showFeedback = (message, type = 'info') => {
            const feedbackBox = document.getElementById('feedback-box');
            feedbackBox.textContent = message;
            feedbackBox.classList.remove('hidden', 'bg-red-500', 'bg-green-500', 'bg-yellow-500', 'bg-blue-500');
            
            let bgColor = 'bg-blue-500';
            if (type === 'error') bgColor = 'bg-red-500';
            if (type === 'success') bgColor = 'bg-green-500';
            if (type === 'warning') bgColor = 'bg-yellow-500';
            
            feedbackBox.classList.add(bgColor);
            
            setTimeout(() => {
                feedbackBox.classList.add('hidden');
            }, 5000);
        };

        // Initial setup call
        initFirebase();
        
        // Call star generation after the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', createStars);
    </script>

    <!-- Floating Feedback Box -->
    <div id="feedback-box" class="fixed top-5 left-1/2 -translate-x-1/2 hidden p-4 rounded-lg shadow-2xl text-white font-semibold z-[100] transition-all duration-300">
        ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    </div>

    <div class="max-w-4xl mx-auto py-8">
        <header class="text-center mb-8">
            <!-- H1 with Moon Emoji üåï -->
            <h1 class="text-5xl font-extrabold text-moon-gold drop-shadow-lg tracking-wider">
                ‡∏•‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå üåï
            </h1>
            <p class="text-xl text-gray-300 mt-2">
                ‡∏£‡πà‡∏ß‡∏°‡∏≠‡∏ò‡∏¥‡∏©‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡πÑ‡∏õ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
            </p>
        </header>

        <!-- Krathong List Display -> SCENE DISPLAY -->
        <div class="bg-water-dark p-2 rounded-2xl shadow-xl border border-water-light/50 mb-6 relative">
            <h2 class="text-3xl font-bold mb-4 text-center text-lotus-pink pt-4">
                ‡∏ú‡∏∑‡∏ô‡∏ô‡πâ‡∏≥‡πÅ‡∏´‡πà‡∏á‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏©‡∏ê‡∏≤‡∏ô (‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 100 ‡∏•‡∏≥)
            </h2>
            <div class="flex justify-between text-sm text-gray-400 mb-2 px-4">
                <span>User ID: <span id="user-id-display" class="font-mono text-xs">...</span></span>
                <span id="loading-status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
            </div>

            <!-- RIVER SCENE CONTAINER (Now with Dark Water, Ripples, Moon, and Stars) -->
            <div id="krathong-list" class="krathong-scene relative w-full">
                <!-- NEW: STAR CONTAINER (Covers the top 40% of the scene) -->
                <div id="star-container" class="star-container"></div>
                
                <!-- MOON ELEMENT -->
                <div class="moon"></div>
                
                <div class="text-center p-8 text-gray-400 absolute inset-0 flex items-center justify-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏∞‡∏ó‡∏á...</div>
            </div>
        </div>

        <!-- Float Krathong Button -->
        <div class="text-center mt-8">
            <button onclick="toggleFloatModal(true)" 
                    class="px-8 py-4 bg-moon-gold text-water-dark font-extrabold text-lg rounded-full shadow-2xl hover:bg-yellow-300 transition-all duration-300 transform hover:scale-105 active:scale-95">
                ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠ ‡∏•‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ó‡∏á üöÄ
            </button>
        </div>
    </div>

    <!-- Krathong Floating Modal -->
    <div id="float-modal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center p-4 hidden z-50">
        <div class="bg-water-light p-8 rounded-2xl shadow-2xl max-w-lg w-full transform transition-all duration-300 border-2 border-moon-gold/50">
            <h3 class="text-3xl font-bold text-moon-gold mb-6 text-center">
                ‡∏•‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üåô
            </h3>
            
            <form id="krathong-form" onsubmit="event.preventDefault(); floatKrathong();">
                
                <!-- Full Name Input -->
                <div class="mb-4">
                    <label for="full-name" class="block text-sm font-medium text-gray-300 mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•)</label>
                    <input type="text" id="full-name" required
                           class="w-full p-3 rounded-lg bg-water-dark border border-gray-600 focus:border-lotus-pink focus:ring-1 focus:ring-lotus-pink text-white"
                           placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏î‡∏ß‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå ‡∏•‡∏≠‡∏¢‡∏ô‡πâ‡∏≥">
                </div>

                <!-- Wish/Blessing Input -->
                <div class="mb-4">
                    <label for="wish" class="block text-sm font-medium text-gray-300 mb-1">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏©‡∏ê‡∏≤‡∏ô/‡∏Ñ‡∏≥‡∏≠‡∏ß‡∏¢‡∏û‡∏£</label>
                    <textarea id="wish" rows="3" required maxlength="100"
                              class="w-full p-3 rounded-lg bg-water-dark border border-gray-600 focus:border-lotus-pink focus:ring-1 focus:ring-lotus-pink text-white"
                              placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á ‡∏ï‡∏•‡∏≠‡∏î‡∏õ‡∏µ"></textarea>
                </div>
                
                <!-- Krathong Selection (UPDATED with SVG) -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-300 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏ó‡∏á</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        
                        <!-- Krathong 1: BananaLeaf (‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡πÉ‡∏ö‡∏ï‡∏≠‡∏á) -->
                        <div>
                            <input type="radio" id="krathong-banana-leaf" name="krathongType" value="BananaLeaf" class="hidden krathong-select-button" required>
                            <label for="krathong-banana-leaf" class="krathong-select-button block p-4 rounded-xl text-center cursor-pointer border-2 border-gray-600 transition-all duration-200">
                                <!-- SVG for Banana Leaf -->
                                <div class="mx-auto w-12 h-12">
                                    <svg viewBox="0 0 48 48" class="w-12 h-12 mx-auto" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M40 24C40 33.9411 31.9411 42 22 42C12.0589 42 4 33.9411 4 24C4 14.0589 12.0589 6 22 6C31.9411 6 40 14.0589 40 24Z" fill="#38A169" opacity="0.8"/>
                                        <path d="M40 24C40 30 35 34 24 34H20C9 34 4 30 4 24" fill="#68D391" opacity="0.6"/>
                                        <rect x="22" y="16" width="4" height="12" rx="2" fill="#9F7A3E"/>
                                        <path d="M24 10C24 8 26 8 26 10C26 12 24 14 24 14C24 14 22 12 22 10C22 8 24 8 24 10Z" fill="#FDE68A"/>
                                        <path d="M24 10C24 9 25 9 25 10C25 11 24 12 24 12C24 12 23 11 23 10C23 9 24 9 24 10Z" fill="#F6AD55"/>
                                        <rect x="27" y="24" width="2" height="6" rx="1" fill="#4A5568"/>
                                        <rect x="19" y="24" width="2" height="6" rx="1" fill="#4A5568"/>
                                    </svg>
                                </div>
                                <span class="text-sm mt-1 block">‡πÉ‡∏ö‡∏ï‡∏≠‡∏á</span>
                            </label>
                        </div>

                        <!-- Krathong 2: Lotus (‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡∏î‡∏≠‡∏Å‡∏ö‡∏±‡∏ß) -->
                        <div>
                            <input type="radio" id="krathong-lotus" name="krathongType" value="Lotus" class="hidden krathong-select-button">
                            <label for="krathong-lotus" class="krathong-select-button block p-4 rounded-xl text-center cursor-pointer border-2 border-gray-600 transition-all duration-200">
                                <!-- SVG for Lotus Flower -->
                                <div class="mx-auto w-12 h-12">
                                    <svg viewBox="0 0 48 48" class="w-12 h-12 mx-auto" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M24 42C30 42 38 38 42 32C46 26 44 18 36 18C36 18 30 14 24 14C18 14 12 18 12 18C4 18 2 26 6 32C10 38 18 42 24 42Z" fill="#EC4899" opacity="0.7"/>
                                        <path d="M24 14L28 26H20L24 14Z" fill="#F9A8D4"/>
                                        <path d="M12 18L18 30L6 32L12 18Z" fill="#F9A8D4"/>
                                        <path d="M36 18L30 30L42 32L36 18Z" fill="#F9A8D4"/>
                                        <rect x="22" y="18" width="4" height="10" rx="2" fill="#FBBF24"/>
                                        <path d="M24 12C24 10 26 10 26 12C26 14 24 16 24 16C24 16 22 14 22 12C22 10 24 10 24 12Z" fill="#FDE68A"/>
                                        <rect x="27" y="26" width="2" height="4" rx="1" fill="#4A5568"/>
                                        <rect x="19" y="26" width="2" height="4" rx="1" fill="#4A5568"/>
                                    </svg>
                                </div>
                                <span class="text-sm mt-1 block">‡∏î‡∏≠‡∏Å‡∏ö‡∏±‡∏ß</span>
                            </label>
                        </div>

                        <!-- Krathong 3: Classic (‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏°) -->
                        <div>
                            <input type="radio" id="krathong-classic" name="krathongType" value="Classic" class="hidden krathong-select-button" checked>
                            <label for="krathong-classic" class="krathong-select-button block p-4 rounded-xl text-center cursor-pointer border-2 border-gray-600 transition-all duration-200">
                                <!-- SVG for Classic Krathong -->
                                <div class="mx-auto w-12 h-12">
                                    <svg viewBox="0 0 48 48" class="w-12 h-12 mx-auto" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="24" cy="40" r="10" fill="#9F7A3E"/>
                                        <path d="M34 35C34 37 32 37 24 37C16 37 14 37 14 35C14 33 24 25 24 25C24 25 34 33 34 35Z" fill="#A0AEC0"/>
                                        <path d="M24 20C28 20 30 24 30 26C30 28 24 30 24 30C24 30 18 28 18 26C18 24 20 20 24 20Z" fill="#38A169"/>
                                        <rect x="22" y="12" width="4" height="10" rx="2" fill="#FFFFFF"/><path d="M24 8C24 6 26 6 26 8C26 10 24 12 24 12C24 12 22 10 22 8C22 6 24 6 24 8Z" fill="#FDE68A"/><rect x="27" y="18" width="2" height="4" rx="1" fill="#4A5568"/><rect x="19" y="18" width="2" height="4" rx="1" fill="#4A5568"/></svg>
                                </div>
                                <span class="text-sm mt-1 block">‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏°</span>
                            </label>
                        </div>

                        <!-- Krathong 4: Coconut (‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡∏Å‡∏∞‡∏•‡∏≤‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß) -->
                        <div>
                            <input type="radio" id="krathong-coconut" name="krathongType" value="Coconut" class="hidden krathong-select-button">
                            <label for="krathong-coconut" class="krathong-select-button block p-4 rounded-xl text-center cursor-pointer border-2 border-gray-600 transition-all duration-200">
                                <!-- SVG for Coconut Krathong -->
                                <div class="mx-auto w-12 h-12">
                                    <svg viewBox="0 0 48 48" class="w-12 h-12 mx-auto" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M40 28C40 35.732 32.8366 42 24 42C15.1634 42 8 35.732 8 28H40Z" fill="#78350F"/>
                                        <path d="M24 26C27.3137 26 30 23.3137 30 20C30 16.6863 27.3137 14 24 14C20.6863 14 18 16.6863 18 20C18 23.3137 20.6863 26 24 26Z" fill="#FBBF24"/>
                                        <rect x="22" y="10" width="4" height="10" rx="2" fill="#FFFFFF"/><path d="M24 6C24 4 26 4 26 6C26 8 24 10 24 10C24 10 22 8 22 6C22 4 24 4 24 6Z" fill="#FDE68A"/>
                                        <rect x="27" y="18" width="2" height="4" rx="1" fill="#4A5568"/>
                                        <rect x="19" y="18" width="2" height="4" rx="1" fill="#4A5568"/>
                                    </svg>
                                </div>
                                <span class="text-sm mt-1 block">‡∏Å‡∏∞‡∏•‡∏≤‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="toggleFloatModal(false)"
                            class="px-5 py-2 border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition-colors">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button type="submit" id="float-button"
                            class="px-5 py-2 bg-lotus-pink text-white font-semibold rounded-lg hover:bg-pink-600 transition-colors disabled:bg-gray-500">
                        ‡∏•‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ó‡∏á
                    </button>
                </div>
            </form>
        </div>
    </div>

</body>
</html>

