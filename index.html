<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏•‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå | Krathong Online</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            'water-dark': '#0f172a',
            'water-light': '#1e293b',
            'moon-gold': '#facc15',
            'lotus-pink': '#ec4899',
          }
        }
      }
    }
  </script>
  <style>
    /* Scene */
    .krathong-scene {
      position: relative; overflow: hidden; min-height: 40rem;
      background: linear-gradient(to bottom,#030712 0%,#0d172e 40%,#1e3a5f 75%);
      border-radius: 0 0 1rem 1rem; z-index: 1;
    }
    /* Moon */
    .moon { position:absolute; top:5%; right:15%; width:60px; height:60px; border-radius:50%;
      background:#facc15; box-shadow:0 0 15px 5px rgba(250,202,21,.6),0 0 30px 10px rgba(250,202,21,.4); z-index:15; }
    /* Stars */
    .star-container{position:absolute; top:0; left:0; width:100%; height:40%; overflow:hidden; pointer-events:none;}
    .star{position:absolute; background:#fff; border-radius:50%; opacity:0; box-shadow:0 0 1px .5px rgba(255,255,255,.7); animation:twinkle linear infinite; z-index:10;}
    @keyframes twinkle{0%,100%{opacity:.8; transform:scale(1);}50%{opacity:.2; transform:scale(.5);}}
    /* Water wave overlay */
    .krathong-scene::after{
      content:''; position:absolute; bottom:0; left:0; right:0; height:70%;
      background: linear-gradient(180deg, rgba(30,58,95,0.0) 0%, rgba(0,0,0,0.4) 15%, rgba(30,58,95,0.2) 35%, rgba(0,0,0,0.4) 55%, rgba(30,58,95,0.2) 75%, rgba(0,0,0,0.4) 95%);
      background-size:100% 600px; animation:waveFlow 40s linear infinite; opacity:.7; z-index:0;
    }
    @keyframes waveFlow{from{background-position:0% 100%;}to{background-position:0% 0%;}}
    /* Krathong */
    .floating-krathong-item{ position:absolute; cursor:pointer; transition:all .5s ease-out; z-index:20; font-size:3rem; line-height:1; }
    @keyframes floatEffect{0%{transform:translateY(0) rotate(0);}50%{transform:translateY(-5px) rotate(1deg);}100%{transform:translateY(0) rotate(0);}}
    .krathong-float{ animation:floatEffect 4s ease-in-out infinite; }
    /* Bubble */
    .speech-bubble{ position:absolute; top:-5px; left:100%; opacity:1; visibility:visible;
      min-width:120px; max-width:180px; background-color:rgba(255,255,255,.95); color:#1e293b;
      padding:6px 10px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,.4); z-index:50; }
    .speech-bubble::after{ content:''; position:absolute; top:15px; left:-8px; border-width:8px; border-style:solid;
      border-color:transparent rgba(255,255,255,.95) transparent transparent; }
    /* Selector highlight */
    .krathong-select-button:checked + label{ border-color:#facc15; background-color:#4c515a33; box-shadow:0 0 10px rgba(250,202,21,.5); }
  </style>
</head>
<body class="bg-water-dark min-h-screen font-sans text-white antialiased p-4">

  <!-- Feedback -->
  <div id="feedback-box" class="fixed top-5 left-1/2 -translate-x-1/2 hidden p-4 rounded-lg shadow-2xl text-white font-semibold z-[100] transition-all duration-300"></div>

  <div class="max-w-4xl mx-auto py-8">
    <header class="text-center mb-8">
      <h1 class="text-5xl font-extrabold text-moon-gold drop-shadow-lg tracking-wider">
        ‡∏•‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå üåï
      </h1>
      <p class="text-xl text-gray-300 mt-2">‡∏£‡πà‡∏ß‡∏°‡∏≠‡∏ò‡∏¥‡∏©‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡πÑ‡∏õ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</p>
    </header>

    <!-- Scene -->
    <div class="bg-water-dark p-2 rounded-2xl shadow-xl border border-water-light/50 mb-3 relative">
      <h2 class="text-3xl font-bold mb-4 text-center text-lotus-pink pt-4">‡∏ú‡∏∑‡∏ô‡∏ô‡πâ‡∏≥‡πÅ‡∏´‡πà‡∏á‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏©‡∏ê‡∏≤‡∏ô (‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 50 ‡∏•‡∏≥)</h2>
      <div class="flex justify-between text-sm text-gray-400 mb-2 px-4">
        <span>User ID: <span id="user-id-display" class="font-mono text-xs">...</span></span>
        <span id="loading-status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
      </div>

      <div id="krathong-list" class="krathong-scene relative w-full">
        <div id="star-container" class="star-container"></div>
        <div class="moon"></div>
        <div class="text-center p-8 text-gray-400 absolute inset-0 flex items-center justify-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏∞‡∏ó‡∏á...</div>
      </div>
      <div class="px-4 py-2 text-right text-xs text-gray-400">
        ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠ <span id="last-updated">‚Äî</span>
      </div>
    </div>

    <!-- Float button -->
    <div class="text-center mt-4">
      <button onclick="toggleFloatModal(true)"
        class="px-8 py-4 bg-moon-gold text-water-dark font-extrabold text-lg rounded-full shadow-2xl hover:bg-yellow-300 transition-all duration-300 transform hover:scale-105 active:scale-95">
        ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠ ‡∏•‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ó‡∏á üöÄ
      </button>
    </div>
  </div>

  <!-- Modal -->
  <div id="float-modal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center p-4 hidden z-50">
    <div class="bg-water-light p-8 rounded-2xl shadow-2xl max-w-lg w-full transform transition-all duration-300 border-2 border-moon-gold/50">
      <h3 class="text-3xl font-bold text-moon-gold mb-6 text-center">‡∏•‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üåô</h3>
      <form id="krathong-form" onsubmit="event.preventDefault(); floatKrathong();">
        <div class="mb-4">
          <label for="full-name" class="block text-sm font-medium text-gray-300 mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•)</label>
          <input type="text" id="full-name" required class="w-full p-3 rounded-lg bg-water-dark border border-gray-600 focus:border-lotus-pink focus:ring-1 focus:ring-lotus-pink text-white" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏î‡∏ß‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå ‡∏•‡∏≠‡∏¢‡∏ô‡πâ‡∏≥">
        </div>
        <div class="mb-4">
          <label for="wish" class="block text-sm font-medium text-gray-300 mb-1">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏©‡∏ê‡∏≤‡∏ô/‡∏Ñ‡∏≥‡∏≠‡∏ß‡∏¢‡∏û‡∏£</label>
          <textarea id="wish" rows="3" required maxlength="100" class="w-full p-3 rounded-lg bg-water-dark border border-gray-600 focus:border-lotus-pink focus:ring-1 focus:ring-lotus-pink text-white" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á ‡∏ï‡∏•‡∏≠‡∏î‡∏õ‡∏µ"></textarea>
        </div>

        <!-- Selector -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-300 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏ó‡∏á</label>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <!-- Banana Leaf -->
            <div>
              <input type="radio" id="krathong-banana-leaf" name="krathongType" value="BananaLeaf" class="hidden krathong-select-button" required>
              <label for="krathong-banana-leaf" class="krathong-select-button block p-4 rounded-xl text-center cursor-pointer border-2 border-gray-600 transition-all duration-200">
                <div class="mx-auto w-12 h-12">
                  <svg viewBox="0 0 48 48" class="w-12 h-12 mx-auto" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M40 24C40 33.9411 31.9411 42 22 42C12.0589 42 4 33.9411 4 24C4 14.0589 12.0589 6 22 6C31.9411 6 40 14.0589 40 24Z" fill="#38A169" opacity="0.8"/>
                    <path d="M40 24C40 30 35 34 24 34H20C9 34 4 30 4 24" fill="#68D391" opacity="0.6"/>
                    <rect x="22" y="16" width="4" height="12" rx="2" fill="#9F7A3E"/>
                    <path d="M24 10C24 8 26 8 26 10C26 12 24 14 24 14C24 14 22 12 22 10C22 8 24 8 24 10Z" fill="#FDE68A"/>
                    <path d="M24 10C24 9 25 9 25 10C25 11 24 12 24 12C24 12 23 11 23 10C23 9 24 9 24 10Z" fill="#F6AD55"/>
                    <rect x="27" y="24" width="2" height="6" rx="1" fill="#4A5568"/>
                    <rect x="19" y="24" width="2" height="6" rx="1" fill="#4A5568"/>
                  </svg>
                </div>
                <span class="text-sm mt-1 block">‡πÉ‡∏ö‡∏ï‡∏≠‡∏á</span>
              </label>
            </div>
            <!-- Lotus -->
            <div>
              <input type="radio" id="krathong-lotus" name="krathongType" value="Lotus" class="hidden krathong-select-button">
              <label for="krathong-lotus" class="krathong-select-button block p-4 rounded-xl text-center cursor-pointer border-2 border-gray-600 transition-all duration-200">
                <div class="mx-auto w-12 h-12">
                  <svg viewBox="0 0 48 48" class="w-12 h-12 mx-auto" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M24 42C30 42 38 38 42 32C46 26 44 18 36 18C36 18 30 14 24 14C18 14 12 18 12 18C4 18 2 26 6 32C10 38 18 42 24 42Z" fill="#EC4899" opacity="0.7"/>
                    <path d="M24 14L28 26H20L24 14Z" fill="#F9A8D4"/>
                    <path d="M12 18L18 30L6 32L12 18Z" fill="#F9A8D4"/>
                    <path d="M36 18L30 30L42 32L36 18Z" fill="#F9A8D4"/><rect x="22" y="18" width="4" height="10" rx="2" fill="#FBBF24"/>
                    <path d="M24 12C24 10 26 10 26 12C26 14 24 16 24 16C24 16 22 14 22 12C22 10 24 10 24 12Z" fill="#FDE68A"/>
                    <rect x="27" y="26" width="2" height="4" rx="1" fill="#4A5568"/>
                    <rect x="19" y="26" width="2" height="4" rx="1" fill="#4A5568"/>
                  </svg>
                </div>
                <span class="text-sm mt-1 block">‡∏î‡∏≠‡∏Å‡∏ö‡∏±‡∏ß</span>
              </label>
            </div>
            <!-- Classic -->
            <div>
              <input type="radio" id="krathong-classic" name="krathongType" value="Classic" class="hidden krathong-select-button" checked>
              <label for="krathong-classic" class="krathong-select-button block p-4 rounded-xl text-center cursor-pointer border-2 border-gray-600 transition-all duration-200">
                <div class="mx-auto w-12 h-12">
                  <svg viewBox="0 0 48 48" class="w-12 h-12 mx-auto" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="24" cy="40" r="10" fill="#9F7A3E"/>
                    <path d="M34 35C34 37 32 37 24 37C16 37 14 37 14 35C14 33 24 25 24 25C24 25 34 33 34 35Z" fill="#A0AEC0"/>
                    <path d="M24 20C28 20 30 24 30 26C30 28 24 30 24 30C24 30 18 28 18 26C18 24 20 20 24 20Z" fill="#38A169"/>
                    <rect x="22" y="12" width="4" height="10" rx="2" fill="#FFFFFF"/>
                    <path d="M24 8C24 6 26 6 26 8C26 10 24 12 24 12C24 12 22 10 22 8C22 6 24 6 24 8Z" fill="#FDE68A"/>
                    <rect x="27" y="18" width="2" height="4" rx="1" fill="#4A5568"/>
                    <rect x="19" y="18" width="2" height="4" rx="1" fill="#4A5568"/>
                  </svg>
                </div>
                <span class="text-sm mt-1 block">‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏°</span>
              </label>
            </div>
            <!-- Coconut -->
            <div>
              <input type="radio" id="krathong-coconut" name="krathongType" value="Coconut" class="hidden krathong-select-button">
              <label for="krathong-coconut" class="krathong-select-button block p-4 rounded-xl text-center cursor-pointer border-2 border-gray-600 transition-all duration-200">
                <div class="mx-auto w-12 h-12">
                  <svg viewBox="0 0 48 48" class="w-12 h-12 mx-auto" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M40 28C40 35.732 32.8366 42 24 42C15.1634 42 8 35.732 8 28H40Z" fill="#78350F"/>
                    <path d="M24 26C27.3137 26 30 23.3137 30 20C30 16.6863 27.3137 14 24 14C20.6863 14 18 16.6863 18 20C18 23.3137 20.6863 26 24 26Z" fill="#FBBF24"/>
                    <rect x="22" y="10" width="4" height="10" rx="2" fill="#FFFFFF"/>
                    <path d="M24 6C24 4 26 4 26 6C26 8 24 10 24 10C24 10 22 8 22 6C22 4 24 4 24 6Z" fill="#FDE68A"/>
                    <rect x="27" y="18" width="2" height="4" rx="1" fill="#4A5568"/>
                    <rect x="19" y="18" width="2" height="4" rx="1" fill="#4A5568"/>
                  </svg>
                </div>
                <span class="text-sm mt-1 block">‡∏Å‡∏∞‡∏•‡∏≤‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß</span>
              </label>
            </div>
          </div>
        </div>

        <div class="flex justify-end space-x-3">
          <button type="button" onclick="toggleFloatModal(false)" class="px-5 py-2 border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="submit" id="float-button" class="px-5 py-2 bg-lotus-pink text-white font-semibold rounded-lg hover:bg-pink-600 transition-colors disabled:bg-gray-500">‡∏•‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ó‡∏á</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase Optimized and Fixed -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, query, limit, getDocs, addDoc, serverTimestamp, setLogLevel, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Config (Vercel Client-Side Deployment) ---
    // ** !!! ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πà‡∏≤ YOUR_... ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å Firebase Console ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì !!! **
    const FIREBASE_CONFIG_CLIENT = {
        apiKey: "AIzaSyC9GFLbMJhYNeRNwod_XPK3ngQh7b4rsAE",
        authDomain: "loy-krathong-vercel-2025.firebaseapp.com",
        projectId: "loy-krathong-vercel-2025",
        storageBucket: "loy-krathong-vercel-2025.firebasestorage.app",
        messagingSenderId: "1015035525573",
        appId: "1:1015035525573:web:8f6dd97206e1004f5533ac"
        // ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
    };

    // ‡πÉ‡∏ä‡πâ config ‡∏ó‡∏µ‡πà hardcode ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Deploy ‡∏ö‡∏ô Vercel
    const firebaseConfig = FIREBASE_CONFIG_CLIENT;
    const appId = FIREBASE_CONFIG_CLIENT.projectId; // ‡πÉ‡∏ä‡πâ Project ID ‡πÄ‡∏õ‡πá‡∏ô App ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î Firestore Path
    const initialAuthToken = null; // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ Custom Token ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Deploy ‡∏ö‡∏ô Static Host

    const KRATHONG_COLLECTION = 'krathongs';
    // ‡πÉ‡∏ä‡πâ appId ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á path ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö public data
    const KRATHONG_PATH = () => `/artifacts/${appId}/public/data/${KRATHONG_COLLECTION}`;

    // --- Icons (SVG) ---
    window.KRATHONG_ICONS = {
      'BananaLeaf': `<svg viewBox="0 0 48 48" class="w-12 h-12 mx-auto" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M40 24C40 33.9411 31.9411 42 22 42C12.0589 42 4 33.9411 4 24C4 14.0589 12.0589 6 22 6C31.9411 6 40 14.0589 40 24Z" fill="#38A169" opacity="0.8"/><path d="M40 24C40 30 35 34 24 34H20C9 34 4 30 4 24" fill="#68D391" opacity="0.6"/><rect x="22" y="16" width="4" height="12" rx="2" fill="#9F7A3E"/><path d="M24 10C24 8 26 8 26 10C26 12 24 14 24 14C24 14 22 12 22 10C22 8 24 8 24 10Z" fill="#FDE68A"/><path d="M24 10C24 9 25 9 25 10C25 11 24 12 24 12C24 12 23 11 23 10C23 9 24 9 24 10Z" fill="#F6AD55"/><rect x="27" y="24" width="2" height="6" rx="1" fill="#4A5568"/><rect x="19" y="24" width="2" height="6" rx="1" fill="#4A5568"/></svg>`,
      'Lotus': `<svg viewBox="0 0 48 48" class="w-12 h-12 mx-auto" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M24 42C30 42 38 38 42 32C46 26 44 18 36 18C36 18 30 14 24 14C18 14 12 18 12 18C4 18 2 26 6 32C10 38 18 42 24 42Z" fill="#EC4899" opacity="0.7"/><path d="M24 14L28 26H20L24 14Z" fill="#F9A8D4"/><path d="M12 18L18 30L6 32L12 18Z" fill="#F9A8D4"/><path d="M36 18L30 30L42 32L36 18Z" fill="#F9A8D4"/><rect x="22" y="18" width="4" height="10" rx="2" fill="#FBBF24"/><path d="M24 12C24 10 26 10 26 12C26 14 24 16 24 16C24 16 22 14 22 12C22 10 24 10 24 12Z" fill="#FDE68A"/><rect x="27" y="26" width="2" height="4" rx="1" fill="#4A5568"/><rect x="19" y="26" width="2" height="4" rx="1" fill="#4A5568"/></svg>`,
      'Classic': `<svg viewBox="0 0 48 48" class="w-12 h-12 mx-auto" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="24" cy="40" r="10" fill="#9F7A3E"/><path d="M34 35C34 37 32 37 24 37C16 37 14 37 14 35C14 33 24 25 24 25C24 25 34 33 34 35Z" fill="#A0AEC0"/><path d="M24 20C28 20 30 24 30 26C30 28 24 30 24 30C24 30 18 28 18 26C18 24 20 20 24 20Z" fill="#38A169"/><rect x="22" y="12" width="4" height="10" rx="2" fill="#FFFFFF"/><path d="M24 8C24 6 26 6 26 8C26 10 24 12 24 12C24 12 22 10 22 8C22 6 24 6 24 8Z" fill="#FDE68A"/><rect x="27" y="18" width="2" height="4" rx="1" fill="#4A5568"/><rect x="19" y="18" width="2" height="4" rx="1" fill="#4A5568"/></svg>`,
      'Coconut': `<svg viewBox="0 0 48 48" class="w-12 h-12 mx-auto" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M40 28C40 35.732 32.8366 42 24 42C15.1634 42 8 35.732 8 28H40Z" fill="#78350F"/><path d="M24 26C27.3137 26 30 23.3137 30 20C30 16.6863 27.3137 14 24 14C20.6863 14 18 16.6863 18 20C18 23.3137 20.6863 26 24 26Z" fill="#FBBF24"/><rect x="22" y="10" width="4" height="10" rx="2" fill="#FFFFFF"/><path d="M24 6C24 4 26 4 26 6C26 8 24 10 24 10C24 10 22 8 22 6C22 4 24 4 24 6Z" fill="#FDE68A"/><rect x="27" y="18" width="2" height="4" rx="1" fill="#4A5568"/><rect x="19" y="18" width="2" height="4" rx="1" fill="#4A5568"/></svg>`
    };

    // --- UI helpers ---
    const showFeedback = (message, type='info') => {
      const box = document.getElementById('feedback-box');
      box.textContent = message;
      box.classList.remove('hidden','bg-red-500','bg-green-500','bg-yellow-500','bg-blue-500');
      const c = {error:'bg-red-500', success:'bg-green-500', warning:'bg-yellow-500', info:'bg-blue-500'};
      box.classList.add(c[type] || 'bg-blue-500');
      setTimeout(()=> box.classList.add('hidden'), 5000);
    };

    const createStars = () => {
      const container = document.getElementById('star-container'); if (!container) return;
      const n = 150;
      for (let i=0;i<n;i++){
        const s = document.createElement('div'); s.className = 'star';
        const size = Math.random()*1 + 1;
        s.style.width = size+'px'; s.style.height = size+'px';
        s.style.top = (Math.random()*100)+'%'; s.style.left = (Math.random()*100)+'%';
        s.style.animationDelay = (Math.random()*5)+'s'; s.style.animationDuration = (Math.random()*3+1.5)+'s';
        container.appendChild(s);
      }
    };

    // --- Render ---
    // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ö array ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß
    const renderKrathongs = (krathongDataArray) => {
      const list = document.getElementById('krathong-list');
      const moon = document.querySelector('.moon');
      const stars = document.getElementById('star-container');
      list.innerHTML = '';
      if (stars) list.appendChild(stars);
      if (moon) list.appendChild(moon);

      if (krathongDataArray.length === 0) {
        list.innerHTML += '<div class="text-center p-8 text-gray-400 absolute inset-0 flex items-center justify-center z-30">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡∏•‡∏≠‡∏¢‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏•‡∏≥‡∏ô‡πâ‡∏≥‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢! ‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏•‡∏≠‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞.</div>';
        return;
      }

      let html = '';
      const hashString = (s) => { let h=0; for (let i=0;i<s.length;i++) { h=((h<<5)-h)+s.charCodeAt(i); h|=0; } return Math.abs(h); };

      // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß
      krathongDataArray.forEach((d) => {
        const icon = window.KRATHONG_ICONS[d.krathongType] || window.KRATHONG_ICONS['Classic'];
        const h = hashString(d.id || d.userId) % 10000; // ‡πÉ‡∏ä‡πâ doc ID ‡∏´‡∏£‡∏∑‡∏≠ User ID ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
        const x = (h % 80) + 10; // 10-90%
        const y = (Math.floor(h/100) % 50) + 40; // 40-90%
        const floatT = 4 + (h % 3);

        html += `
          <div class="floating-krathong-item krathong-float" style="left:${x}%; top:${y}%; animation-duration:${floatT}s;">
            <div class="leading-none">${icon}</div>
            <div class="speech-bubble">
              <p class="text-xs font-bold truncate">${d.name || '‡∏ú‡∏π‡πâ‡∏•‡∏≠‡∏¢‡∏ô‡∏¥‡∏£‡∏ô‡∏≤‡∏°'}</p>
              <p class="text-[0.65rem] italic text-gray-700 leading-tight mt-0.5 max-h-8 overflow-hidden">"${d.wish || '‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç'}"</p>
            </div>
          </div>`;
      });

      list.insertAdjacentHTML('beforeend', html);
    };

    // --- Last updated label ---
    const setLastUpdated = () => {
      const pad = (n) => n.toString().padStart(2,'0');
      const now = new Date();
      const t = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
      document.getElementById('last-updated').textContent = t;
    };

    // --- Fetch once (limit 50) and sort client-side ---
    let db, auth, refreshTimer = null;
    const fetchKrathongsOnce = async () => {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ db ‡∏ñ‡∏π‡∏Å initialize ‡πÅ‡∏•‡πâ‡∏ß
      if (!db) return;
      
      const ref = collection(db, KRATHONG_PATH());
      // Query without orderBy, fetch the latest 50 documents (limit 50)
      const q = query(ref, limit(50));
      try {
        const snapshot = await getDocs(q);

        // 1. Convert snapshot to array and include document ID
        let krathongs = [];
        snapshot.forEach(doc => {
            const data = doc.data();
            // Firestore timestamp can be either Firestore.Timestamp or Date/null if saving locally
            const timestampSeconds = data.timestamp?.seconds || (data.timestamp instanceof Date ? data.timestamp.getTime() / 1000 : 0);
            krathongs.push({...data, id: doc.id, timestampSeconds: timestampSeconds});
        });

        // 2. Sort client-side by timestamp in descending order (newest first)
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ timestampSeconds ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á
        krathongs.sort((a, b) => b.timestampSeconds - a.timestampSeconds);

        // 3. Render the sorted array
        renderKrathongs(krathongs);

        document.getElementById('loading-status').textContent = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß';
        setLastUpdated();
      } catch (e) {
        console.error('Error fetching:', e);
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Permission Denied ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Debug Security Rules
        showFeedback('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + (e.message.includes('permission') ? '‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Security Rules)' : e.message), 'error');
      }
    };

    // --- Float action ---
    window.floatKrathong = async () => {
      if (!auth?.currentUser) return showFeedback('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'warning');
      const name = document.getElementById('full-name').value.trim();
      const wish = document.getElementById('wish').value.trim();
      const type = document.querySelector('input[name="krathongType"]:checked')?.value;
      if (!name || !wish || !type) return showFeedback('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏ó‡∏á', 'warning');

      const btn = document.getElementById('float-button');
      btn.disabled = true; btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ó‡∏á...';

      try {
        const ref = collection(db, KRATHONG_PATH());
        await addDoc(ref, { name, wish, krathongType: type, userId: auth.currentUser.uid, timestamp: serverTimestamp() });
        document.getElementById('krathong-form').reset();
        toggleFloatModal(false);
        showFeedback('‡∏•‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! üéâ', 'success');
        // refresh now
        fetchKrathongsOnce();
      } catch (e) {
        console.error(e);
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô
        showFeedback('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + (e.message.includes('permission') ? '‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Security Rules)' : e.message), 'error');
      } finally {
        btn.disabled = false; btn.textContent = '‡∏•‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ó‡∏á';
      }
    };

    // --- Modal ---
    window.toggleFloatModal = (show) => {
      const modal = document.getElementById('float-modal');
      if (show) { modal.classList.remove('hidden'); document.body.classList.add('overflow-hidden'); }
      else { modal.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); }
    };

    // --- Init ---
    const init = async () => {
      try {
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 'Debug' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
        setLogLevel('Debug');
        
        // ** FIX: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á Firebase Config ‡∏Å‡πà‡∏≠‡∏ô Initial App **
        if (!firebaseConfig.projectId) {
            console.error('Init error: Firebase configuration is missing projectId. Please replace "YOUR_PROJECT_ID" in the config block.');
            showFeedback('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (Project ID)', 'error');
            return; 
        }

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // 1. Authenticate using custom token or anonymously
        // ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ initialAuthToken (‡πÄ‡∏õ‡πá‡∏ô null ‡πÉ‡∏ô Vercel static host) ‡∏à‡∏∂‡∏á‡πÉ‡∏ä‡πâ signInAnonymously()
        if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken).catch(e => {
                console.error("Custom token sign-in failed, falling back to anonymous.", e);
                return signInAnonymously(auth);
            });
        } else {
            await signInAnonymously(auth);
        }

        // Offline cache (best-effort)
        enableIndexedDbPersistence(db).catch((e) => console.warn('Offline cache unavailable or already enabled.', e));

        // 2. Set up Auth State Listener
        onAuthStateChanged(auth, (u) => {
          if (u) {
            document.getElementById('user-id-display').textContent = u.uid;
            document.getElementById('loading-status').textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
            // First load and continuous polling for updates
            fetchKrathongsOnce();
            if (refreshTimer) clearInterval(refreshTimer);
            // Polling every 30s as using getDocs instead of onSnapshot
            refreshTimer = setInterval(fetchKrathongsOnce, 30000);
          } else {
            // Should not happen after initial sign-in above, but good practice
            document.getElementById('user-id-display').textContent = '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
            document.getElementById('loading-status').textContent = '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
          }
        });
      } catch (e) {
        console.error('Init error (Firebase app init failed):', e);
        showFeedback('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + e.message, 'error');
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      createStars();
      init();
    });
  </script>
</body>
</html>
